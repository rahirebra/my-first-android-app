name: Build Android APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Checkout code
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # 2. Setup Java
    - name: Setup Java JDK
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 3. Handle gradle-wrapper.jar placeholder
    - name: Setup Gradle Wrapper
      run: |
        echo "=== Checking current wrapper ==="
        ls -la gradle/wrapper/ || echo "No wrapper directory"
        
        # If placeholder exists, download real one
        if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "Placeholder found, downloading real gradle-wrapper.jar..."
          wget -q -O gradle/wrapper/gradle-wrapper.jar \
            https://repo.maven.apache.org/maven2/gradle/wrapper/gradle-wrapper/8.0/gradle-wrapper-8.0.jar
        else
          echo "Creating gradle wrapper directory..."
          mkdir -p gradle/wrapper
          wget -q -O gradle/wrapper/gradle-wrapper.jar \
            https://repo.maven.apache.org/maven2/gradle/wrapper/gradle-wrapper/8.0/gradle-wrapper-8.0.jar
        fi
        
        # Ensure gradle-wrapper.properties exists
        if [ ! -f "gradle/wrapper/gradle-wrapper.properties" ]; then
          cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-8.0-bin.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
        fi
        
        # Ensure gradlew exists
        if [ ! -f "gradlew" ]; then
          echo "Creating gradlew script..."
          cat > gradlew << 'EOF'
          #!/bin/sh
          
          # Simple gradlew placeholder
          echo "Using gradle wrapper..."
          exec gradle "$@"
          EOF
          chmod +x gradlew
        fi
        
        echo "=== Wrapper setup complete ==="
        ls -la gradle/wrapper/
        
    # 4. Setup Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # 5. Accept Android Licenses
    - name: Accept Android Licenses
      run: |
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
    # 6. Build the APK
    - name: Build APK
      run: |
        echo "=== Starting build ==="
        ./gradlew assembleDebug --stacktrace || gradle assembleDebug --stacktrace
        
    # 7. Upload APK
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: MyFirstApp-APK
        path: app/build/outputs/apk/debug/*.apk
        
    # 8. Create Release
    - name: Create GitHub Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: app/build/outputs/apk/debug/app-debug.apk
        tag_name: v1.0.${{ github.run_number }}
        name: Release v1.0.${{ github.run_number }}
        body: |
          ## ðŸŽ‰ Android App Built on GitHub!
          
          **Successfully built with placeholder gradle-wrapper.jar!**
          
          How to install:
          1. Download APK below
          2. Enable "Unknown sources" in Android settings
          3. Install and enjoy!
